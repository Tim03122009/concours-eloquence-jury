<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Résultats Concours</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        
        .action-button { padding: 10px 20px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; margin-right: 10px; transition: 0.3s; }
        .load-button { background-color: #28a745; color: white; }
        .export-button { background-color: #ffc107; color: #343a40; font-weight: bold; }
        .export-button.excel { background-color: #007bff; color: white; }

        .candidate-zone { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #fff; border-radius: 5px; }
        .candidate-zone textarea { width: 98%; min-height: 100px; padding: 10px; margin-bottom: 10px; }

        #scores-matrix { width: 100%; border-collapse: collapse; margin-bottom: 40px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 0.9em; }
        #scores-matrix th, #scores-matrix td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        #scores-matrix th { background-color: #f2f2f2; }
        
        .detail-note { font-size: 0.8em; color: #666; display: block; border-bottom: 1px solid #eee; margin-bottom: 3px; }
        .weighted-total { font-weight: bold; color: #007bff; }
        .total-score { background-color: #ffc107; font-weight: bold; font-size: 1.1em; }
        .eliminado { background-color: #dc3545; color: white; }

        #podium-table { width: 100%; max-width: 650px; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #podium-table th, #podium-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .rank-1 { background-color: gold; font-weight: bold; }
        .rank-2 { background-color: silver; font-weight: bold; }
        .rank-3 { background-color: #cd7f32; color: white; font-weight: bold; }
        .eliminated-row { background-color: #6c757d; color: white; }

        .reset-zone { margin-top: 50px; padding: 15px; border: 2px solid #dc3545; background-color: #f8d7da; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Tableau de bord Administrateur</h1>
    
    <div class="candidate-zone">
        <h2>1. Liste des Candidats</h2>
        <textarea id="candidate-names" placeholder="Un nom par ligne..."></textarea>
        <button onclick="saveCandidateList()" class="action-button" style="background:#007bff; color:white;">Sauvegarder la Liste</button>
    </div>

    <hr>
    
    <h2>2. Calcul des Résultats (Note1 x3 + Note2 x1)</h2>
    <div>
        <button onclick="loadAllScores()" class="action-button load-button">Charger et Calculer</button>
        <button onclick="exportToExcel()" class="action-button export-button excel">Excel (.csv)</button>
        <button onclick="exportPodiumToImage()" class="action-button export-button">Podium (Image)</button>
    </div>

    <table id="scores-matrix">
        <thead><tr><th>Candidat</th></tr></thead>
        <tbody></tbody>
    </table>

    <h2>Classement Officiel</h2>
    <table id="podium-table">
        <thead>
            <tr><th>Rang</th><th>Candidat</th><th>Score Pondéré</th><th>Statut</th></tr>
        </thead>
        <tbody id="podium-body"></tbody>
    </table>

    <div class="reset-zone">
        <h2>Zone de Danger</h2>
        <button onclick="confirmResetAllData()" class="action-button" style="background:#dc3545; color:white;">RÉINITIALISER TOUS LES SCORES</button>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="module">
        import { db } from './firebase-init.js';
        import { collection, getDocs, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        let CANDIDATES = [];
        let aggregatedData = {};

        // --- GESTION CANDIDATS ---
        window.saveCandidateList = async () => {
            const names = document.getElementById('candidate-names').value.split('\n').map(n => n.trim()).filter(n => n !== "");
            const list = names.map((n, i) => ({ id: `C${i+1}`, name: n }));
            await setDoc(doc(db, "candidats", "liste_actuelle"), { candidates: list });
            alert("Liste mise à jour !");
            location.reload();
        };

        const loadList = async () => {
            const snap = await getDoc(doc(db, "candidats", "liste_actuelle"));
            if (snap.exists()) {
                CANDIDATES = snap.data().candidates;
                document.getElementById('candidate-names').value = CANDIDATES.map(c => c.name).join('\n');
            }
        };
        loadList();

        // --- CALCUL DES SCORES ---
        window.loadAllScores = async () => {
            const querySnapshot = await getDocs(collection(db, "scores"));
            aggregatedData = {};
            const juries = new Set();

            CANDIDATES.forEach(c => {
                aggregatedData[c.id] = { name: c.name, total: 0, juryScores: {}, elimCount: 0, hasScores: false };
            });

            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (aggregatedData[data.candidateId]) {
                    juries.add(data.juryName);
                    aggregatedData[data.candidateId].hasScores = true;
                    aggregatedData[data.candidateId].juryScores[data.juryName] = data;
                    
                    if (data.score1 === "Elimine") {
                        aggregatedData[data.candidateId].elimCount++;
                    } else {
                        aggregatedData[data.candidateId].total += data.totalWeightedScore;
                    }
                }
            });

            renderMatrix(Array.from(juries).sort());
            renderPodium();
        };

        function renderMatrix(sortedJuries) {
            const thead = document.querySelector("#scores-matrix thead tr");
            const tbody = document.querySelector("#scores-matrix tbody");
            thead.innerHTML = "<th>Candidat</th>" + sortedJuries.map(j => `<th>${j}</th>`).join('') + "<th>Total</th>";
            tbody.innerHTML = "";

            CANDIDATES.forEach(c => {
                const data = aggregatedData[c.id];
                const row = tbody.insertRow();
                row.insertCell().innerHTML = `<b>${c.name}</b>`;
                
                sortedJuries.forEach(j => {
                    const scoreObj = data.juryScores[j];
                    const cell = row.insertCell();
                    if (scoreObj) {
                        if (scoreObj.score1 === "Elimine") {
                            cell.className = "eliminado";
                            cell.textContent = "ÉLIMINÉ";
                        } else {
                            cell.innerHTML = `<span class="detail-note">${scoreObj.score1} | ${scoreObj.score2}</span><span class="weighted-total">${scoreObj.totalWeightedScore}</span>`;
                        }
                    } else { cell.textContent = "-"; }
                });
                const totalCell = row.insertCell();
                totalCell.className = "total-score";
                totalCell.textContent = data.total;
            });
        }

        function renderPodium() {
            const body = document.getElementById('podium-body');
            body.innerHTML = "";
            let list = Object.values(aggregatedData).filter(c => c.hasScores).sort((a,b) => b.total - a.total);
            
            list.forEach((c, i) => {
                const row = body.insertRow();
                if (c.elimCount >= 3) row.className = "eliminated-row";
                else if (i === 0) row.className = "rank-1";
                else if (i === 1) row.className = "rank-2";
                else if (i === 2) row.className = "rank-3";

                row.insertCell().textContent = c.elimCount >= 3 ? "—" : i + 1;
                row.insertCell().textContent = c.name;
                row.insertCell().textContent = c.total;
                row.insertCell().textContent = c.elimCount >= 3 ? `ÉLIMINÉ (${c.elimCount} jurys)` : "Qualifié";
            });
        }

        window.confirmResetAllData = async () => {
            if(confirm("Supprimer TOUS les scores ?")){
                const snap = await getDocs(collection(db, "scores"));
                for (const d of snap.docs) { await deleteDoc(doc(db, "scores", d.id)); }
                location.reload();
            }
        };
    </script>
</body>
</html>