<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Résultats Concours</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        
        /* Styles pour tous les boutons d'action */
        .action-button { 
            padding: 10px 20px; 
            font-size: 1.1em; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-bottom: 20px; 
            margin-right: 10px; /* Ajout d'une petite marge entre les boutons */
            transition: background-color 0.3s; 
        }
        
        /* Style spécifique pour le bouton CHARGEMENT (Vert) */
        .load-button { 
            background-color: #28a745; 
            color: white;
        }
        .load-button:hover { background-color: #1e7e34; }

        /* Style spécifique pour les boutons de TÉLÉCHARGEMENT (Orange/Bleu) */
        .export-button {
            background-color: #ffc107; /* Jaune/Orange */
            color: #343a40; /* Texte foncé */
            font-weight: bold;
        }
        .export-button.excel {
             background-color: #007bff; /* Bleu */
             color: white;
        }
        .export-button:hover {
            opacity: 0.9;
        }

        /* Styles pour la Matrice */
        #scores-matrix { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 40px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9em;
        }
        #scores-matrix th, #scores-matrix td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: center;
        }
        #scores-matrix th { 
            background-color: #f2f2f2; 
            font-weight: bold; 
        }
        .candidate-name { text-align: left; font-weight: bold; }
        .total-score { background-color: #ffc107; font-weight: bold; }
        .eliminado { background-color: #dc3545; color: white; }
        
        /* Styles pour le Podium */
        #podium-table { 
            width: 100%;
            max-width: 600px;
            margin-top: 20px; 
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #podium-table th, #podium-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .rank-1 { background-color: gold; font-weight: bold; }
        .rank-2 { background-color: silver; font-weight: bold; }
        .rank-3 { background-color: #cd7f32; color: white; font-weight: bold; }
        .eliminated-row { background-color: #6c757d; color: white; }

        /* Styles pour la zone de Réinitialisation */
        .reset-zone {
            margin-top: 50px;
            padding: 15px; 
            border: 2px solid #dc3545; 
            background-color: #f8d7da; 
            border-radius: 5px;
        }
        .reset-button {
            background-color: #dc3545 !important; /* Rouge vif */
            color: white;
            font-weight: bold;
        }
        .reset-button:hover { background-color: #c82333 !important; }
    </style>
</head>
<body>

    <h1>Tableau de bord Administrateur</h1>
    <p>Cliquez pour récupérer et calculer les scores de tous les jurys.</p>
    
    <div>
        <button onclick="loadAllScores()" class="action-button load-button">Charger et Calculer les Résultats</button>
        <button onclick="exportToExcel()" class="action-button export-button excel">Télécharger Matrice Excel</button>
        <button onclick="exportPodiumToImage()" class="action-button export-button">Télécharger Podium Image</button>
    </div>


    <h2>Matrice des Scores (Jury vs Candidats)</h2>
    <p>Ce tableau affiche le score donné par chaque jury à chaque candidat.</p>
    <table id="scores-matrix">
        <thead>
            <tr>
                <th>Candidat</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <hr>

    <h2>Classement (Top 18)</h2>
    <p id="total-candidates">Total de candidats évalués : 0</p>
    <table id="podium-table">
        <thead>
            <tr>
                <th>Rang</th>
                <th>Candidat</th>
                <th>Score Total</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody id="podium-body">
        </tbody>
    </table>

    <div class="reset-zone">
        <h2>Zone de Réinitialisation (pour les tests)</h2>
        <p>ATTENTION : Cette action supprimera TOUTES les données de la base de données Firestore (scores) et videra VOTRE nom de jury enregistré pour pouvoir refaire des tests.</p>
        <button onclick="confirmResetAllData()" class="action-button reset-button">Supprimer TOUS les Scores et Réinitialiser le Jury</button>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js"></script>
    
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
        // Logique de l'administrateur
        import { db } from './firebase-init.js';
        import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        // Liste des 35 candidats (doit correspondre à celle de script.js)
        const CANDIDATES = Array.from({length: 35}, (_, i) => ({
            id: `C${i + 1}`,
            name: `Candidat ${i + 1}`
        }));
        
        let aggregatedData = {}; // Global pour l'export Excel/Image
        let rawScores = []; // Global pour l'export Excel/Image

        // --------------------------------------------------------------------------------
        // FONCTIONS D'EXPORTATION
        // --------------------------------------------------------------------------------

        // Fonction pour exporter la Matrice de Scores vers Excel (CSV)
        window.exportToExcel = function() {
            if (Object.keys(aggregatedData).length === 0) {
                alert("Veuillez d'abord charger les résultats.");
                return;
            }
            
            const matrixTable = document.getElementById('scores-matrix');
            let csv = [];
            
            // 1. Récupérer les en-têtes (Jury Names + Candidat + Total)
            const headers = Array.from(matrixTable.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(';'));
            
            // 2. Récupérer les lignes de données
            matrixTable.querySelectorAll('tbody tr').forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    // Remplacer les virgules par des points pour éviter les problèmes de format CSV dans certains tableurs
                    return td.textContent.replace(/,/g, '.');
                });
                csv.push(rowData.join(';'));
            });

            // 3. Créer le lien de téléchargement
            const csvContent = "data:text/csv;charset=utf-8," + csv.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `matrice_scores_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Fonction pour exporter le Podium vers une image (PNG)
        window.exportPodiumToImage = function() {
            if (document.getElementById('podium-body').children.length === 0) {
                alert("Veuillez d'abord charger les résultats.");
                return;
            }

            const podiumTable = document.getElementById('podium-table');

            // Utilise la librairie html2canvas pour prendre une "photo" du tableau
            html2canvas(podiumTable, {
                scale: 2, // Double la résolution pour une meilleure qualité
                useCORS: true 
            }).then(canvas => {
                // Créer le lien de téléchargement
                const link = document.createElement('a');
                link.download = `podium_classement_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // --------------------------------------------------------------------------------
        // NOUVELLES FONCTIONS : RÉINITIALISATION COMPLÈTE
        // --------------------------------------------------------------------------------

        window.confirmResetAllData = function() {
            if (confirm("Êtes-vous ABSOLUMENT sûr de vouloir supprimer tous les scores et réinitialiser votre navigateur ? Cette action est irréversible et supprime toutes les données du concours !")) {
                resetAllData();
            }
        }

        async function resetAllData() {
            try {
                // 1. SUPPRIMER TOUS LES SCORES DE FIREBASE
                const scoresRef = collection(db, "scores");
                const snapshot = await getDocs(scoresRef);
                
                const deletePromises = [];
                snapshot.forEach(docData => {
                    deletePromises.push(deleteDoc(doc(db, "scores", docData.id)));
                });

                await Promise.all(deletePromises);

                // 2. EFFACER L'AFFICHAGE ET LE STOCKAGE LOCAL DE L'ADMIN
                document.getElementById('scores-matrix').querySelector('tbody').innerHTML = '';
                document.getElementById('podium-body').innerHTML = '';
                document.getElementById('total-candidates').textContent = 'Total de candidats évalués : 0';

                // Vider les données globales
                aggregatedData = {};
                rawScores = [];

                // Nettoyage de ton stockage local pour tes tests
                localStorage.clear(); 
                
                alert("Réinitialisation complète réussie ! Tous les scores ont été supprimés et VOTRE navigateur a été remis à zéro.");

            } catch (error) {
                console.error("Erreur lors de la réinitialisation des données :", error);
                alert("Erreur lors de la réinitialisation. Vérifiez la console (F12) pour les détails.");
            }
        }

        // --------------------------------------------------------------------------------
        // FONCTION PRINCIPALE EXISTANTE
        // --------------------------------------------------------------------------------
        
        // Fonction principale appelée par le bouton
        window.loadAllScores = async function() {
            try {
                // Récupération de tous les scores de la collection "scores"
                const scoresRef = collection(db, "scores");
                const snapshot = await getDocs(scoresRef);
                
                rawScores = []; // Réinitialisation de la variable globale
                snapshot.forEach(doc => {
                    rawScores.push(doc.data());
                });

                if (rawScores.length === 0) {
                    alert("Aucun score trouvé dans la base de données.");
                    return;
                }

                // --- 1. Agrégation des données ---
                aggregatedData = {}; // Réinitialisation de la variable globale
                const juryList = new Set();
                
                // Initialisation des données pour chaque candidat
                CANDIDATES.forEach(c => {
                    aggregatedData[c.id] = { 
                        id: c.id, // Ajout de l'ID pour le tri si nécessaire
                        name: c.name, 
                        total: 0, 
                        scores: {},
                        elimineCount: 0,
                        hasScores: false // Pour filtrer les candidats non évalués
                    };
                });

                // Traitement des scores reçus
                rawScores.forEach(score => {
                    const candidateId = score.candidateId;
                    const juryName = score.juryName;
                    const note = score.score;

                    if (!aggregatedData[candidateId]) return;

                    juryList.add(juryName);
                    aggregatedData[candidateId].scores[juryName] = note;
                    aggregatedData[candidateId].hasScores = true;
                    
                    if (note !== "Elimine") {
                        aggregatedData[candidateId].total += parseInt(note);
                    } else {
                        aggregatedData[candidateId].elimineCount += 1;
                    }
                });
                
                const sortedJuries = Array.from(juryList).sort();
                
                // --- 2. Construction de la Matrice (Tableau Excel) ---
                buildScoreMatrix(aggregatedData, sortedJuries);
                
                // --- 3. Construction du Podium ---
                buildPodium(aggregatedData);

                alert("Résultats chargés et calculés avec succès !");

            } catch (error) {
                console.error("Erreur lors du chargement des scores :", error);
                alert("Erreur de connexion à Firebase. Vérifiez la console pour les détails. (Vérifiez votre fichier firebase-init.js et vos règles de sécurité)");
            }
        }

        function buildScoreMatrix(aggregatedData, sortedJuries) {
            const matrixTable = document.getElementById('scores-matrix');
            const matrixHeadRow = matrixTable.querySelector('thead tr');
            const matrixBody = matrixTable.querySelector('tbody');
            
            // Mise à jour de l'entête : Candidat | Jury 1 | Jury 2 | ... | Total
            matrixHeadRow.innerHTML = '<th>Candidat</th>';
            sortedJuries.forEach(jury => {
                matrixHeadRow.innerHTML += `<th>${jury}</th>`;
            });
            matrixHeadRow.innerHTML += '<th>Total</th>';

            // Mise à jour du corps
            matrixBody.innerHTML = '';
            
            CANDIDATES.forEach(candidate => {
                const row = matrixBody.insertRow();
                // Affichage du nom du candidat sous le format Candidat X (CX)
                row.innerHTML += `<td class="candidate-name">${candidate.name} (${candidate.id})</td>`;
                
                // Affichage des notes par jury
                sortedJuries.forEach(jury => {
                    const score = aggregatedData[candidate.id].scores[jury] || '-';
                    const cellClass = score === 'Elimine' ? 'eliminado' : '';
                    
                    row.innerHTML += `<td class="${cellClass}">${score}</td>`;
                });
                
                // Affichage du Total
                const total = aggregatedData[candidate.id].total;
                row.innerHTML += `<td class="total-score">${total}</td>`;
            });
        }

        function buildPodium(aggregatedData) {
            let finalScores = Object.keys(aggregatedData).map(id => aggregatedData[id]);

            // Filtrer les candidats qui n'ont reçu aucun score
            finalScores = finalScores.filter(c => c.hasScores);
            
            // Tri : Du plus grand total au plus petit
            finalScores.sort((a, b) => b.total - a.total);
            
            // Mise à jour de la table du Podium
            const podiumBody = document.getElementById('podium-body');
            podiumBody.innerHTML = '';
            
            let rank = 0;
            let displayedCount = 0;
            const topLimit = 18; // Afficher le Top 18

            // Affichage du classement
            finalScores.forEach((candidate, index) => {
                // On arrête l'affichage si on a atteint la limite
                if (displayedCount >= topLimit) return; 

                // Attribution du rang
                if (index === 0 || candidate.total < finalScores[index - 1].total) {
                    rank = displayedCount + 1;
                }
                
                // Incrémenter le nombre affiché
                displayedCount++;
                
                const row = podiumBody.insertRow();
                let rankClass = '';
                
                // Gestion des classes pour le style
                if (candidate.elimineCount >= 3) { // Règle: Éliminé si 3 jurys ou plus ont mis "Éliminé"
                    rankClass = 'eliminated-row';
                } else if (rank === 1) {
                    rankClass = 'rank-1';
                } else if (rank === 2) {
                    rankClass = 'rank-2';
                } else if (rank === 3) {
                    rankClass = 'rank-3';
                }

                row.className = rankClass;
                
                const totalJuries = Object.keys(candidate.scores).length;

                const statut = candidate.elimineCount >= 3 
                    ? `ÉLIMINÉ (par ${candidate.elimineCount}/${totalJuries} jurys)` 
                    : 'Qualifié';

                row.innerHTML += `<td>${candidate.elimineCount >= 3 ? '—' : rank}</td>`;
                row.innerHTML += `<td>${candidate.name}</td>`;
                row.innerHTML += `<td>${candidate.total}</td>`;
                row.innerHTML += `<td>${statut}</td>`;
            });
            
            document.getElementById('total-candidates').textContent = `Total de candidats ayant reçu un score : ${finalScores.length} (Top 18 affichés)`;
        }

    </script>
</body>
</html>