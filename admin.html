<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Concours Éloquence</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .action-button { padding: 10px 20px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .load-button { background-color: #28a745; color: white; }
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        .rank-1 { background-color: #ffd700; font-weight: bold; }
        .reset-zone { margin-top: 50px; padding: 20px; border: 2px solid #dc3545; background-color: #f8d7da; border-radius: 8px; }
        .reset-button { background-color: #dc3545; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Tableau de bord Administrateur</h1>
    <button onclick="loadAllScores()" class="action-button load-button">Actualiser les Résultats</button>

    <h2>Matrice des Scores (Fond / Forme)</h2>
    <table id="scores-matrix">
        <thead><tr id="matrix-header"><th>Candidat</th><th>Total</th></tr></thead>
        <tbody id="matrix-body"></tbody>
    </table>

    <h2>Classement (Podium)</h2>
    <table id="podium-table">
        <thead><tr><th>Rang</th><th>Candidat</th><th>Score Total</th></tr></thead>
        <tbody id="podium-body"></tbody>
    </table>

    <div class="reset-zone">
        <h2>Zone de Réinitialisation</h2>
        <p>Action : Supprimer les scores et forcer la déconnexion des jurys (si F5).</p>
        <button onclick="confirmResetAllData()" class="action-button reset-button">RÉINITIALISER TOUT</button>
    </div>

    <script type="module">
        import { db } from './firebase-init.js';
        import { collection, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        window.loadAllScores = async function() {
            const snapshot = await getDocs(collection(db, "scores"));
            const juryList = new Set();
            const results = {};

            snapshot.forEach(doc => {
                const data = doc.data();
                juryList.add(data.juryName);
                if (!results[data.candidateId]) results[data.candidateId] = { juryScores: {}, total: 0 };
                results[data.candidateId].juryScores[data.juryName] = `${data.score1}/${data.score2}`;
                results[data.candidateId].total += data.totalWeightedScore;
            });

            const sortedJuries = Array.from(juryList).sort();
            const header = document.getElementById('matrix-header');
            header.innerHTML = '<th>Candidat</th>' + sortedJuries.map(j => `<th>${j}</th>`).join('') + '<th>Total</th>';

            const body = document.getElementById('matrix-body');
            body.innerHTML = '';
            for (const id in results) {
                let row = `<tr><td>${id}</td>`;
                sortedJuries.forEach(j => row += `<td>${results[id].juryScores[j] || '-'}</td>`);
                row += `<td><b>${results[id].total}</b></td></tr>`;
                body.innerHTML += row;
            }

            const sortedPodium = Object.entries(results).sort((a,b) => b[1].total - a[1].total);
            const pBody = document.getElementById('podium-body');
            pBody.innerHTML = '';
            sortedPodium.forEach((c, i) => {
                pBody.innerHTML += `<tr class="${i===0?'rank-1':''}"><td>${i+1}</td><td>${c[0]}</td><td>${c[1].total}</td></tr>`;
            });
        };

        window.confirmResetAllData = async function() {
            if (!confirm("Attention : supprimer tous les scores et déconnecter les jurys ?")) return;
            try {
                const snap = await getDocs(collection(db, "scores"));
                for (const d of snap.docs) await deleteDoc(doc(db, "scores", d.id));
                await updateDoc(doc(db, "config", "session"), { current_id: Date.now().toString() });
                alert("Réinitialisation réussie !");
                location.reload();
            } catch (e) {
                alert("Erreur. Vérifiez que la collection 'config/session' existe dans Firebase.");
            }
        };
    </script>
</body>
</html>